name: Build and Release Avalonia App

on:
  push:
    tags:
      - 'v*' # 推送以'v'开头的标签时触发，例如 v1.0.0
  workflow_dispatch: # 允许在GitHub网页界面上手动触发工作流
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'

env:
  SOLUTION_NAME: 'stcpui.sln' # 请替换为你的解决方案文件名
  PROJECT_PATH: 'stcpui.csproj' # 请替换为你的桌面项目路径

jobs:
  build:
    runs-on: ${{ matrix.os }}-latest
    strategy:
      matrix:
        # 定义多个独立的、值为基本类型数组的变量
        os: [windows,macos]
        shell: [msys2, bash]
        compiler-cc: [gcc, clang]
        compiler-cxx: [g++, clang++]
    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2: 设置 .NET 环境
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # 步骤 3: 缓存 NuGet 包以加速后续构建
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 步骤 4: 还原项目依赖
      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_NAME }}

      # 步骤 5: 运行测试（如果你的项目有测试）
      - name: Run Tests
        run: dotnet test ${{ env.SOLUTION_NAME }} --configuration Release --verbosity normal --no-restore

      # 步骤 6: 发布应用（单文件、裁剪、预编译）
      - name: Publish Application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
          -c Release `
          -r ${{ matrix.platform.runtime }} `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          --output ./publish/${{ matrix.platform.name }}
        shell: pwsh # 为Windows Runner指定PowerShell，其他系统会忽略此设置

      # 步骤 7: 上传构建产物（Artifact），便于临时查看或手动发布
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: avalonia-app-${{ matrix.platform.name }}-${{ github.sha }}
          path: ./publish/${{ matrix.platform.name }}
          retention-days: 7 # 产物保留7天

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    # 仅在构建作业成功且是标签推送时运行
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 下载之前所有平台构建的产物
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./combined-artifacts
          pattern: avalonia-app-*
          merge-multiple: true

      - name: Create GitHub Release
        # 这是一个流行的创建Release的Action
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Automated build for Avalonia application.
            **Platforms included:** Windows (x64), Linux (x64), macOS (x64).
          files: ./combined-artifacts/**/*
        env:
          # 需要配置一个具有 repo 权限的 Token（通常使用内置的 GITHUB_TOKEN）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
